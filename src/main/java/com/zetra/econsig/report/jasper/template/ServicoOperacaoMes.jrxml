<!-- Created with Jaspersoft Studio version 7.0.1.final using JasperReports Library version 7.0.1-573496633c2b4074e32f433154b543003f7d2498  -->
<jasperReport name="ServicoOperacaoMes" language="java" pageWidth="842" pageHeight="595" orientation="Landscape" whenNoDataType="AllSectionsNoDetail" columnWidth="782" leftMargin="30" rightMargin="30" topMargin="20" bottomMargin="20" uuid="b327739c-ea57-4fc5-9f96-f999e85788ef">
	<property name="ireport.zoom" value="1.5"/>
	<property name="ireport.x" value="456"/>
	<property name="ireport.y" value="0"/>
	<property name="ireport.scriptlethandling" value="0"/>
	<property name="ireport.encoding" value="ISO-8859-1"/>
	<import>net.sf.jasperreports.engine.*</import>
	<import>java.util.*</import>
	<import>net.sf.jasperreports.engine.data.*</import>
	<style name="Celula">
		<box leftPadding="2" rightPadding="2"/>
	</style>
	<parameter name="SUBREPORT_DIR" class="java.lang.String">
		<defaultValueExpression><![CDATA["./"]]></defaultValueExpression>
	</parameter>
	<parameter name="CAMINHO_LOGO" forPrompting="false" class="java.lang.String"/>
	<parameter name="SUBTITULO" forPrompting="false" class="java.lang.String">
		<description><![CDATA[Subtitulo do relatï¿½rio]]></description>
	</parameter>
	<parameter name="TEXTO_RODAPE" forPrompting="false" class="java.lang.String">
		<description><![CDATA[Nome do Gestor(Consignante)]]></description>
	</parameter>
	<parameter name="TITULO" forPrompting="false" class="java.lang.String"/>
	<parameter name="FORMATO_ARQUIVO" forPrompting="false" class="java.lang.String"/>
	<parameter name="OPERACAO_POR_CSA" class="java.lang.Boolean">
		<defaultValueExpression><![CDATA[false]]></defaultValueExpression>
	</parameter>
	<parameter name="RESPONSAVEL" class="com.zetra.econsig.helper.seguranca.AcessoSistema"/>
	<parameter name="LISTA_SERVICO_OPERACAO_MES" forPrompting="false" class="java.util.List">
		<defaultValueExpression><![CDATA[new java.util.ArrayList()]]></defaultValueExpression>
	</parameter>
	<parameter name="LISTA_SERVICO_OPERACAO_MES_POR_CSA" forPrompting="false" class="java.util.List">
		<defaultValueExpression><![CDATA[new java.util.ArrayList()]]></defaultValueExpression>
	</parameter>
	<query language="sql"><![CDATA[select
SERVICO AS SERVICO,
sum(case when Tipo = '1' then Total else 0 end) AS ATIVO_INICIO_MES,
sum(case when Tipo = '2' then Total else 0 end) AS ATIVO_FIM_MES,
sum(case when Tipo = '3' then Total else 0 end) AS QUITADOS,
sum(case when Tipo = '4' then Total else 0 end) AS RENEGOCIADOS,
sum(case when Tipo = '5' then Total else 0 end) AS NOVOS,
sum(case when Tipo = '6' then Total else 0 end) AS TOTAL_VALOR_DESCONTADO_MES,
sum(case when Tipo = '7' then Total else 0 end) AS PARTICIPACAO_TOTAL_SERVIDORES,
sum(case when Tipo = '8' then Total else 0 end) AS PARTICIPACAO_TOTAL_DESCONTADO,
(case when Tipo = '9' then Total else 0 end) AS RETENCAO_GOVERNO
from (
   select
   svc.svc_descricao as Servico, '1' as Tipo, count(*) as Total
   from tb_aut_desconto ade
   inner join tb_verba_convenio vco on (ade.vco_codigo = vco.vco_codigo)
   inner join tb_convenio cnv on (vco.cnv_codigo = cnv.cnv_codigo)
   inner join tb_servico svc on (svc.svc_codigo = cnv.svc_codigo)
   inner join tb_consignataria csa on (cnv.csa_codigo = csa.csa_codigo)
   where ade.ade_data < '2009-07-01 00:00:00'
   and
   (
      ade.sad_codigo not in
      (
         '3','7','8','9'
      )
      or
      (
         ade.sad_codigo in ('7','8')
         and exists (
            select
            1
            from tb_ocorrencia_autorizacao oca
            where oca.ade_codigo = ade.ade_codigo
            and oca.toc_codigo in ('6','7')
            and oca.oca_data > '2009-07-01 00:00:00'
         )
      )
   )
   group by svc.svc_codigo
   union
   select
   svc.svc_descricao, '2' as Tipo, count(*) as Total
   from tb_aut_desconto ade
   inner join tb_verba_convenio vco on (ade.vco_codigo = vco.vco_codigo)
   inner join tb_convenio cnv on (vco.cnv_codigo = cnv.cnv_codigo)
   inner join tb_servico svc on (svc.svc_codigo = cnv.svc_codigo)
   inner join tb_consignataria csa on (cnv.csa_codigo = csa.csa_codigo)
   where ade.ade_data < '2009-07-30 00:00:00'
   and
   (
      ade.sad_codigo not in
      (
         '3','7','8','9'
      )
      or
      (
         ade.sad_codigo in ('7','8')
         and exists
         (
            select
            1
            from tb_ocorrencia_autorizacao oca
            where oca.ade_codigo = ade.ade_codigo
            and oca.toc_codigo in ('6','7')
            and oca.oca_data > '2009-07-30 00:00:00'
         )
      )
   )
   group by svc.svc_codigo
   union
   select
   svc.svc_descricao, '3' as Tipo, count(*) as Total
   from tb_aut_desconto ade
   inner join tb_verba_convenio vco on (ade.vco_codigo = vco.vco_codigo)
   inner join tb_convenio cnv on (vco.cnv_codigo = cnv.cnv_codigo)
   inner join tb_servico svc on (svc.svc_codigo = cnv.svc_codigo)
   inner join tb_consignataria csa on (cnv.csa_codigo = csa.csa_codigo)
   inner join tb_ocorrencia_autorizacao oca on (oca.ade_codigo = ade.ade_codigo)
   where ade.sad_codigo = '8'
   and oca.toc_codigo = '6'
   and oca.oca_data between '2009-07-01 00:00:00'  and '2009-07-30 00:00:00'
   group by svc.svc_codigo
   union
   select
   svc.svc_descricao, '4' as Tipo, count(*) as Total
   from tb_aut_desconto ade
   inner join tb_verba_convenio vco on (ade.vco_codigo = vco.vco_codigo)
   inner join tb_convenio cnv on (vco.cnv_codigo = cnv.cnv_codigo)
   inner join tb_servico svc on (svc.svc_codigo = cnv.svc_codigo)
   inner join tb_consignataria csa on (cnv.csa_codigo = csa.csa_codigo)
   inner join tb_relacionamento_autorizacao rad on
   (
      rad.ade_codigo_origem = ade.ade_codigo
   )
   inner join tb_aut_desconto ade2 on (rad.ade_codigo_destino = ade2.ade_codigo)
   where ade.sad_codigo in ('8','9')
   and rad.tnt_codigo = '6'
   and ade2.sad_codigo <> '7'
   and rad.rad_data between '2009-07-01 00:00:00'  and '2009-07-30 00:00:00'
   group by svc.svc_codigo
   union
   select
   svc.svc_descricao, '5' as Tipo, count(*) as Total
   from tb_aut_desconto ade
   inner join tb_verba_convenio vco on (ade.vco_codigo = vco.vco_codigo)
   inner join tb_convenio cnv on (vco.cnv_codigo = cnv.cnv_codigo)
   inner join tb_servico svc on (svc.svc_codigo = cnv.svc_codigo)
   inner join tb_consignataria csa on (cnv.csa_codigo = csa.csa_codigo)
   where ade.ade_data between '2009-07-01 00:00:00'  and '2009-07-30 00:00:00'
   group by svc.svc_codigo
   union
   select
   svc.svc_descricao, '6' as Tipo, sum(prd_vlr_realizado)
   from tb_aut_desconto ade
   inner join tb_verba_convenio vco on (ade.vco_codigo = vco.vco_codigo)
   inner join tb_convenio cnv on (vco.cnv_codigo = cnv.cnv_codigo)
   inner join tb_servico svc on (svc.svc_codigo = cnv.svc_codigo)
   inner join tb_consignataria csa on (cnv.csa_codigo = csa.csa_codigo)
   inner join tb_parcela_desconto prd on (ade.ade_codigo = prd.ade_codigo)
   where prd.prd_data_desconto = '2009-07-01'
   and prd.spd_codigo = '6'
   group by svc.svc_codigo
   union
   select
   svc.svc_descricao,
   '7' as Tipo,
   count(*)/(select count(*) from tb_registro_servidor rse where rse.srs_codigo <> '3')
   as Total
   from tb_aut_desconto ade
   inner join tb_verba_convenio vco on (ade.vco_codigo = vco.vco_codigo)
   inner join tb_convenio cnv on (vco.cnv_codigo = cnv.cnv_codigo)
   inner join tb_servico svc on (svc.svc_codigo = cnv.svc_codigo)
   inner join tb_consignataria csa on (cnv.csa_codigo = csa.csa_codigo)
   where
   (
      ade.sad_codigo not in
      (
         '3','7','8','9'
      )
      or
      (
         ade.sad_codigo in ('7','8')
         and exists
         (
            select
            1
            from tb_ocorrencia_autorizacao oca
            where oca.ade_codigo = ade.ade_codigo
            and oca.toc_codigo in ('6','7')
            and oca.oca_data > '2009-07-30 00:00:00'
         )
      )
   )
   group by svc.svc_codigo
   union
   select
   svc.svc_descricao,
   '8' as Tipo,
   sum(prd.prd_vlr_realizado)/(select sum(prd2.prd_vlr_realizado) from tb_parcela_desconto prd2 where prd2.prd_data_desconto = '2009-07-01' and prd2.spd_codigo = '6') as Total
   from tb_aut_desconto ade
   inner join tb_verba_convenio vco on (ade.vco_codigo = vco.vco_codigo)
   inner join tb_convenio cnv on (vco.cnv_codigo = cnv.cnv_codigo)
   inner join tb_servico svc on (svc.svc_codigo = cnv.svc_codigo)
   inner join tb_consignataria csa on (cnv.csa_codigo = csa.csa_codigo)
   inner join tb_parcela_desconto prd on (ade.ade_codigo = prd.ade_codigo)
   where prd.prd_data_desconto = '2009-07-01'
   and prd.spd_codigo = '6'
   group by svc.svc_codigo
   union
   select
   SERVICO,
   '9' AS Tipo,
   cast(CASE WHEN FORMA = 'VALOR FIXO' THEN SUM(QUANTIDADE1 * TARIFA) ELSE SUM((VALOR1 * TARIFA)/100) END as decimal(13, 2)) AS Total
   FROM
   (
      SELECT
      tb_servico.svc_descricao as SERVICO,
      CASE WHEN COALESCE(NULLIF(tb_param_svc_consignataria.psc_vlr_ref,''),tb_param_tarif_consignante.pcv_forma_calc) = '1' THEN 'VALOR FIXO' ELSE 'PERCENTUAL' END AS FORMA,
      cast(COUNT(DISTINCT tb_parcela_desconto.ade_codigo) as decimal( 13, 2)) AS QUANTIDADE1,
      SUM(tb_aut_desconto.ade_vlr) AS VALOR1,
      COALESCE
      (
         NULLIF(tb_param_svc_consignataria.psc_vlr,''),
         tb_param_tarif_consignante.pcv_vlr
      )
      AS TARIFA
      FROM tb_parcela_desconto
      INNER JOIN tb_aut_desconto ON
      (
         tb_parcela_desconto.ade_codigo = tb_aut_desconto.ade_codigo
      )
      INNER JOIN tb_verba_convenio ON
      (
         tb_aut_desconto.vco_codigo = tb_verba_convenio.vco_codigo
      )
      INNER JOIN tb_convenio ON
      (
         tb_verba_convenio.cnv_codigo = tb_convenio.cnv_codigo
      )
      INNER JOIN tb_servico ON (tb_convenio.svc_codigo = tb_servico.svc_codigo)
      INNER JOIN tb_param_tarif_consignante ON
      (
         tb_convenio.svc_codigo = tb_param_tarif_consignante.svc_codigo
      )
      INNER JOIN tb_consignataria ON
      (
         tb_convenio.csa_codigo = tb_consignataria.csa_codigo
      )
      LEFT OUTER
      JOIN tb_param_svc_consignataria ON
      (
         tb_param_svc_consignataria.tps_codigo = '176'
         AND tb_param_tarif_consignante.svc_codigo = tb_param_svc_consignataria.svc_codigo
         AND tb_consignataria.csa_codigo = tb_param_svc_consignataria.csa_codigo
      )
      WHERE tb_param_tarif_consignante.pcv_base_calc = '2'
      AND tb_param_tarif_consignante.pcv_vlr > 0.00
      AND tb_parcela_desconto.spd_codigo = '6'
      AND tb_parcela_desconto.prd_data_desconto = '2009-07-01'
      GROUP BY tb_servico.svc_descricao,
      tb_param_tarif_consignante.pcv_base_calc,
      tb_param_tarif_consignante.pcv_forma_calc,
      tb_param_tarif_consignante.pcv_vlr,
      tb_param_svc_consignataria.psc_vlr,
      tb_param_svc_consignataria.psc_vlr_ref,
      tb_convenio.svc_codigo
   )
   AS RETENCAO
   GROUP BY SERVICO, FORMA, TARIFA
   ORDER BY SERVICO
)
as X
group by Servico
order by 1]]></query>
	<background splitType="Stretch"/>
	<title splitType="Stretch"/>
	<pageHeader height="86" splitType="Stretch">
		<element kind="image" uuid="b2c705fd-76b4-43dd-9866-5b9dc487568f" key="image-1" x="2" y="1" width="63" height="20" onErrorType="Blank" usingCache="true" lazy="true">
			<expression><![CDATA[$P{CAMINHO_LOGO}]]></expression>
			<box>
				<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<bottomPen lineWidth="0.0" lineColor="#000000"/>
				<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
			</box>
		</element>
		<element kind="textField" uuid="a163da7e-61ed-415b-8501-469713ecb327" key="textField-11" x="68" y="3" width="714" height="13" fontName="Arial" blankWhenNull="false" bold="true" hTextAlign="Left">
			<expression><![CDATA[$P{TITULO}]]></expression>
			<box>
				<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<bottomPen lineWidth="0.0" lineColor="#000000"/>
				<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
			</box>
		</element>
		<element kind="textField" uuid="1f56c1a8-7642-4afc-98da-75e952795b62" key="textField-19" stretchType="ElementGroupHeight" x="2" y="25" width="779" height="60" fontName="Arial" fontSize="8.0" textAdjust="StretchHeight" blankWhenNull="false" bold="true" hTextAlign="Left">
			<expression><![CDATA[$P{SUBTITULO}]]></expression>
			<box>
				<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<bottomPen lineWidth="0.0" lineColor="#000000"/>
				<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
			</box>
		</element>
	</pageHeader>
	<columnHeader splitType="Stretch"/>
	<detail>
		<band height="52" splitType="Stretch">
			<element kind="subreport" uuid="fec5265e-d184-47e7-b5ee-988e8716e969" key="subreport-1" x="0" y="27" width="779" height="24" usingCache="true">
				<printWhenExpression><![CDATA[$P{OPERACAO_POR_CSA} && $P{LISTA_SERVICO_OPERACAO_MES_POR_CSA} != null && !$P{LISTA_SERVICO_OPERACAO_MES_POR_CSA}.isEmpty()]]></printWhenExpression>
				<dataSourceExpression><![CDATA[new net.sf.jasperreports.engine.data.JRBeanCollectionDataSource($P{LISTA_SERVICO_OPERACAO_MES_POR_CSA})]]></dataSourceExpression>
				<expression><![CDATA[$P{SUBREPORT_DIR} + "ServicoOperacaoMesPorCsa.jasper"]]></expression>
				<parameter name="SUBREPORT_DIR">
					<expression><![CDATA[$P{SUBREPORT_DIR}]]></expression>
				</parameter>
				<parameter name="FORMATO_ARQUIVO">
					<expression><![CDATA[$P{FORMATO_ARQUIVO}]]></expression>
				</parameter>
				<parameter name="TITULO">
					<expression><![CDATA[$P{TITULO}]]></expression>
				</parameter>
				<parameter name="CAMINHO_LOGO">
					<expression><![CDATA[$P{CAMINHO_LOGO}]]></expression>
				</parameter>
				<parameter name="RESPONSAVEL">
					<expression><![CDATA[$P{RESPONSAVEL}]]></expression>
				</parameter>
				<parameter name="OPERACAO_POR_CSA">
					<expression><![CDATA[$P{OPERACAO_POR_CSA}]]></expression>
				</parameter>
				<parameter name="SUBTITULO">
					<expression><![CDATA[$P{SUBTITULO}]]></expression>
				</parameter>
				<parameter name="TEXTO_RODAPE">
					<expression><![CDATA[$P{TEXTO_RODAPE}]]></expression>
				</parameter>
			</element>
			<element kind="break" uuid="c35c03cb-5f09-4844-8ab5-1084b0d6c078" key="element-25" positionType="Float" x="0" y="26" width="535" height="1">
				<printWhenExpression><![CDATA[$P{OPERACAO_POR_CSA} && $P{LISTA_SERVICO_OPERACAO_MES_POR_CSA} != null && !$P{LISTA_SERVICO_OPERACAO_MES_POR_CSA}.isEmpty()]]></printWhenExpression>
			</element>
			<element kind="subreport" uuid="fec5265e-d184-47e7-b5ee-988e8716e969" key="subreport-3" x="1" y="2" width="779" height="24" usingCache="true">
				<dataSourceExpression><![CDATA[new net.sf.jasperreports.engine.data.JRBeanCollectionDataSource($P{LISTA_SERVICO_OPERACAO_MES})]]></dataSourceExpression>
				<expression><![CDATA[$P{SUBREPORT_DIR} + "ServicoOperacaoMesPorSvc.jasper"]]></expression>
				<parameter name="SUBREPORT_DIR">
					<expression><![CDATA[$P{SUBREPORT_DIR}]]></expression>
				</parameter>
				<parameter name="CAMINHO_LOGO">
					<expression><![CDATA[$P{CAMINHO_LOGO}]]></expression>
				</parameter>
				<parameter name="TITULO">
					<expression><![CDATA[$P{TITULO}]]></expression>
				</parameter>
				<parameter name="FORMATO_ARQUIVO">
					<expression><![CDATA[$P{FORMATO_ARQUIVO}]]></expression>
				</parameter>
				<parameter name="RESPONSAVEL">
					<expression><![CDATA[$P{RESPONSAVEL}]]></expression>
				</parameter>
				<parameter name="OPERACAO_POR_CSA">
					<expression><![CDATA[false]]></expression>
				</parameter>
				<parameter name="SUBTITULO">
					<expression><![CDATA[$P{SUBTITULO}]]></expression>
				</parameter>
				<parameter name="TEXTO_RODAPE">
					<expression><![CDATA[$P{TEXTO_RODAPE}]]></expression>
				</parameter>
			</element>
		</band>
	</detail>
	<columnFooter splitType="Stretch"/>
	<pageFooter height="18" splitType="Stretch">
		<element kind="textField" uuid="7fd38dfa-6a09-4d41-8aef-1154ac7d323b" key="textField" x="0" y="4" width="676" height="13" fontName="Times New Roman" fontSize="7.0" blankWhenNull="true">
			<expression><![CDATA[$P{TEXTO_RODAPE}]]></expression>
			<box>
				<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<bottomPen lineWidth="0.0" lineColor="#000000"/>
				<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
			</box>
		</element>
		<element kind="textField" uuid="231fd038-01ac-4102-8c68-02478e7c0bd5" key="textField-12" x="676" y="4" width="60" height="13" blankWhenNull="false" hTextAlign="Right">
			<expression><![CDATA[$V{PAGE_NUMBER} + ""]]></expression>
			<box>
				<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<bottomPen lineWidth="0.0" lineColor="#000000"/>
				<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
			</box>
		</element>
		<element kind="textField" uuid="dfdf3226-b76d-4cef-8377-4c2eae318839" key="textField-13" x="736" y="4" width="45" height="13" evaluationTime="Report" blankWhenNull="false" hTextAlign="Left">
			<expression><![CDATA[" " + com.zetra.econsig.helper.texto.ApplicationResourcesHelper.getMessage("rotulo.relatorio.de.pagina", $P{RESPONSAVEL}, $V{PAGE_NUMBER}.toString())]]></expression>
			<box>
				<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				<bottomPen lineWidth="0.0" lineColor="#000000"/>
				<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
			</box>
		</element>
	</pageFooter>
	<summary splitType="Stretch"/>
</jasperReport>
